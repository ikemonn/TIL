# 遅延処理
## 割り込み処理の遅延
- 割り込み処理の遅延機構
  - ソフト割り込み
  - tasklet(ソフト割り込みを汎用化したもの)
- 応答性を必要とするハードウェアを制御する処理は割り込みハンドラ
- それ以外はソフト割り込みハンドラ or tasklet
- ソフトウェア割り込み処理はハードウェア割り込みを禁止しない
  - ソフト割り込み処理中でもハードウェア割り込みの受付可能

## マルチプロセッサへの対応
- 複数のCPU上で同時にソフト割り込みハンドラを実行できる
- ソフト割り込みハンドラはその要因を作ったハードウェア割り込みハンドラと同じCPU上で動作する

## ソフト割り込みスタック
- ソフト割り込みハンドラではTCP/IPプロトコル処理、SCSIプロトコル処理、端末制御など比較的重い処理が実行される
  - 逐次実行されるためスタックが無限に消費されることはない

## ソフト割り込み
- ハードウェア割り込み処理が要因となって発生する
- ソフト割り込みハンドラはハードウェア割り込みハンドラで行った処理を引き継ぎ、動作する

## tasklet
- ソフト割り込みの一種
- ソフト割り込みとして利用できる割り込み種別は予め定義されていて有限
  - taskletは任意の関数をソフト割り込みハンドラとして登録し、実行できるように拡張したもの

### データ構造
- 通常のソフト割り込みでは1つのソフト割り込み種別に対して1つのソフト割り込みハンドラが登録されている
  - tasklet用のソフト割り込み種別に関しては複数の関数が登録出来る構造になっている

## workqueue
- 遅延処理を実現する仕組み
- プロセスコンテキストの処理を遅延させるために使う
  - もともと割り込みコンテキストの遅延処理もtaskletではなく、workqueueが使われていた
- 指定した処理を複数登録しておき、後から実行の指示を与える
- 指示があると専用のカーネルスレッドが動作を始め、登録されている処理を順番に呼び出していく
- 即時実行と時限処理を組み合わせた一定時間後実行の2つが用意されている
- 各種デバイスドライバの遅延実行、ブロックI/O要求の遅延実行、非同期I/O処理などにつかわれている
- kevent_wqという汎用のworkqueueがあり、基本的にこれを使っている
  - 非同期I/O、ブロックI/O、XFSファイルシステムなど処理効率のために動作タイミングを正確に捉える必要があるものだけ専用のworkqueueを使っている

# 時計
## 時計の役割
- 時刻を正確に刻む
- 一定時間後に指定した処理をおこなう
- 一定間隔で周期的に発生する割り込み(タイマー割り込み)を利用して、上記の処理を行う時計機能を実現している

## 3つの時計
- グローバルな時計とCPUローカルな時計がある
- グローバルな時計
  - システム全体に関わる処理を行う
    - グローバルな時計の割り込みは周期的(HZ)に発生し、システム上のいずれかのCPUに対して通知される
- CPUローカルな時計
  - 特定のCPUに関わる処理を行う
    - 各CPUにおいて定期的に割り込みが行われる
    - 「ハードウェア割り込みハンドラ」「ソフト割り込みハンドラ」の２段階で処理される

## Linuxの時刻
- Linuxカーネル内部では1970/1/1 0時からの経過時間をxtime変数に記録するt古都で時計を実現している
- 一定周期に動作するグローバルタイマー割り込みハンドラで時刻が進められる


## ハードウェアのカレンダ
- ほぼすべてのコンピュータハードウェアは内部にカレンダ(RTC Real Time Clock)と呼ばれるコントローラを持っている
  - 本質的にLinuxとは無関係の世界で独自の時間を刻んでいる
- Linuxカーネルは起動時にハードウェアのカレンダをLinux内部時計(xtime変数)に反映させる
  - そのあとは原則Linux内部時計とハードウェアカレンダの同期は行わない

## jiffies
- Linuxカーネル起動時を0とする関数
  - Linuxカーネル起動後に発生したタイマー割り込みの回数を数えることにより実現している
  - Linuxの時限処理ベースとしてのみ利用されている

## タイマーリスト
- 登録した一定時間後にコールバックされるハンドラを登録できる
  - ネットワークのタイムアウト処理やリトライ処理など数多く利用されている
- 実行して欲しい時刻を指定してタイマーリストにハンドラを登録しておくと、ローカルタイマーソフト割り込みハンドラがこの起動時間を監視し、指定した時間がきたら呼び出してくれる

### タイマーリストの構造
- ハンドラ実行は各CPUが独立に行えるように、各CPUでハンドラ登録用の表を管理している
  - tv1~5の副表があり、短時間後〜長時間後に実行される

### タイマーリストの実行
- タイマーリストはローカルタイマーソフト割り込みハンドラ(run_timer_softiq)によって実行される
- ローカルタイマーソフト割り込みハンドラは、動作のたびにtv1の1エントリに登録されているハンドラを実行していく
  - 1つのエントリに複数のハンドラが登録されている場合は、全てのハンドラを呼び出す
  

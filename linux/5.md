# システムコール
## システムコールとカーネルサービス

- システムコール
  - プロセスがカーネルに明示的にサービスを要求するインターフェイスのこと

### リソースの管理を実現する保護機能
- リソースの管理
  - メモリやファイルを管理し、複数のプロセスから発行されるハードウェアへのアクセス要求を調停すること
  - 過大な要求を行うプロセスはエラー終了させられたり、不正なアクセスを行おうとしたプロセスは強制終了させられたりする
- 上記の機能を実現するためにカーネルはCPUの提供する保護機能を利用する
- プロテクトモード
  - 特権レベル0(特権あり) ~ 3(なし)
  - カーネルは特権レベル0、プロセスは3(1,2は使用しない)
- 例えば、プロセスはHDDに直接アクセスできない
  - カーネルに一旦処理を依頼する(特権レベルを3→0に)
  - カーネルがシステムコールをに対するサービスを実行するためには、特権レベル3から0に移る必要がある
    - プロセスから直接カーネルの関数を呼び出せないようになっている

### 特権レベルの変更
- アーキテクチャごとの固有の方法で変更する(下記はi386の場合)
  - ソフトウェア割り込みを利用
  - コールゲートを利用
  - タスクゲートを利用
  - sysenter命令を利用
- 上記のうちLinuxではソフトウェア割り込みの0x80番を利用する方法と、sysenterを利用する方法を使っている

### システムコールのインターフェイス
- CPUアーキテクチャによってカーネルの特権モードを変更する方法は様々
  - 現代的なOSではアーキテクチャに依存するコードはライブラリ(通常はglibc)内に隠蔽されている

### システムコール番号とエントリテーブル
- それぞれのシステムコールにはシステムコール番号が振られている
  - カーネルはシステムコール発行時に渡されたシステムコール番号によって、どのシステムコールが要求されたかを区別する
    - カーネル内には実際にシステムコール要求をする関数が定義されている(sys_XXX)
    - 内部的にそれらの関数の配列が定義されており、そのインデックス番号がシステムコール番号

### シグナルによる割り込み(システムコールの再起動とアボート)
- システムコールの処理中、プロセスはイベントを待って待機状態になることがある

## int 0x80とsysenterを切り替えるvsyscall

### vsyscallの機能、役割
- カーネルが定義した実行コードをユーザ空間なら参照できるようにして、ライブラリから実行させるもの
- システムコールを発行するために、ライブラリはカーネルから指定されたアドレスを呼び出し、カーネルが定義したコードを実行する
- 実行しているCPUにとってint 0x80命令が使用されていたり、sysenter命令が使用されているので virtual systemcallと呼ばれる

- カーネル呼び出しが不要な処理であれば、実際にはシステムコールを発行せずに処理を済ますことが出来る
  - カーネル呼び出しのほうが関数呼び出しに比べて遅いので処理が高速化される


## プロセス空間へのアクセスと例外テーブル
- しばしばシステムコールの処理中にか＝ネルはプロセスの空間にアクセスする必要がある
  - ただし、プログラム上の間違いなどからプロセスが正しい値を渡してくれるとは限らない
  - カーネルは処理するデータを厳しくチェックしなければならない

# アドレス変換機構
## 仮想アドレス空間のオデル
### 仮想アドレス空間
- 0番地から始まる単一でリニアなアドレス空間
- 仮想アドレス空間の大きさはCPUのアーキテクチャによって異なるが、32bitであれば通常4G
### ページ
- 実メモリはある一定の大きさに区切られており、その一区切りのこと
  - この一区切りを実ページまたはページフレームと呼ぶ
- 仮想アドレス空間も同じ大きさに区切って管理する
  - この一区切りを仮想ページと呼ぶ
- ページの大きさはCPUのアーキテクチャによって異なる

### ページ変換テーブル
- 仮想アドレスから実アドレスへの変換は仮想ページと実ページの対応表(ページ変換テーブル)を基にページ単位で行われる
  - ページ変換テーブルこそが仮想アドレス空間を作っている実体といえる
- ページ変換テーブルは仮想アドレス空間ごとに存在する
  - プロセスごとに存在する
- プロセス切替時にカーネル内で切り替える資源の1つとなる
- 仮想アドレスから実アドレスへの変換は、ハードウェアがページ変換テーブルに従って自動的に行う
  - ページ変換テーブルの設定はカーネルの役割

## Linuxのページ変換テーブル
- Linuxではページ変換テーブルを4段のテーブルにモデル化し、そのテーブルへのアクセス関数を定義してインターフェースとしている
  - 最上位のテーブルから「ページグローバルディレクトリ」「ページアッパーディレクトリ」「ページミドルディレクトリ」「ページテーブル」と呼ぶ
- ページ変換テーブルを利用した、仮想アドレスから実アドレスへの変換方法(3段のページテーブルで説明する。4段でも同じ)
  1. 仮想アドレスは4つの部位に分けられる
  - ページグローバルディレクトリの各エントリには、ページミドルディレクトリの先頭アドレス(実アドレス)が入る
    - 仮想アドレスの最上位の部位をページグローバルディレクトリのインデックスとみなして対応するエントリからページミドルディレクトリを求める
  - ページミドルディレクトリの各エントリには、ページテーブルの先頭アドレス(実アドレス)が入る
    - 仮想アドレスの第二の部位をページミドルディレクトリのインデックスとみなして、2で求めたページテーブルのの対応するエントリからページテーブルを求める
  - ページテーブルの各エントリには実ページの先頭アドレスが入る
    - 仮想アドレスの第三の部位をページテーブルのインデックスとみなして、3で求めたページテーブルの対応するエントリから実ページを求める
  - 仮想アドレスの再開の部位はページ内のオフセットになる
    - 4で求めた実ページの先頭アドレスにこのオフセットをたせは仮想アドレスに対応する実アドレスになる

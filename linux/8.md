# シグナル処理
## シグナル機構の実装
- シグナル
  - カーネル/プロセスがプロセスに対し、プロセス内外で起きた同期/非同期事象をプロセスに通知する仕組み
  - シグナルが生成されプロセスに配送されるとプロセスが指定したシグナルハンドラが実行される
    - その間、それまでの実行は一旦停止する
    - シグナルハンドラが処理を終えると元の処理に戻る
  - ハンドラが指定されていないとデフォルトの処理が行われる
- 同期非同期シグナルの使われ方
  - 同期シグナル
    - メモリ保護例外(SIGSEGV)、不正な命令の実行(SIGILL)など
  - 非同期シグナル
    - インターバルタイマ(SIGALM)、非同期I/Oの完了通知(Ctrl+C, SIGINT)、Ctrl+Z(SIGTSTP)、killコマンドなど

### シグナルの配送先とスレッド
- シグナルの配送先は同期/非同期によって異なる
  - 同期シグナル
    - その事象を起こしたスレッド
  - 非同期シグナル
    - スレッドグループ
    - 実際のシグナル配送先スレッドはスレッドの配送時に決まる
### シグナルのマスク
- アプリケーションの処理上、シグナルが配送されてはまずいときがある
  - この場合シグナルをマスクできる
- シグナルがマスクされている間、シグナルは保留され、マスクが解除された時にシグナルが配送される
  - シグナルが保留されている間に同じシグナルが複数回生成されてもシグナルは1度しか配送されない

### スレッドとシグナルハンドラ/マスク
- シグナルハンドラはスレッドグループに対して設定される
- シグナルマスクはスレッドごとに設定される
- シグナルが生成されたとき、シグナルをマスクしていないスレッドがあればその中の1つにシグナルが配送される
  - どのスレッドもマスクしている場合はシグナルは保留される
  - マルチスレッドアプリケーションの場合、シグナル処理専用のスレッドを用意し、それ以外のスレッドはシグナルをマスクする

## シグナル処理のカーネルコード
- シグナルを利用するためのデータ構造の準備
- シグナルハンドラとマスクの設定
- シグナルの配送
- シグナルとジョブコントロール

### データ構造
- sigset_t
  - 現在マスクしているシグナルを表す
  - シグナルマスクはプロセスごとに定義される
- sigpending
  - 生成されて配送待ちをしているシグナル
- sighand
  - sigactionシステムコールで登録されたシグナルハンドラを格納する

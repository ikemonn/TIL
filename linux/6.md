# 同期と排他
## プロセスコンテキスト同士の排他
- 複数のプロセスから依頼されたシステムコールのためのカーネル処理は同時に走行する
- カーネルスレッドが実行するカーネル処理も同時に動作する
  - これらが勝手気ままにアクセスしないように制御する仕組みが必要
### セマフォ
- プロセスコンテキストの延長で動作するカーネル処理同士であれば、セマフォと呼ばれる機構を利用して資源の排他アクセスを実現できる
- 一般に比較的長い時間確保する資源に対して利用する
- 排他アクセスを必要とする資源に対してセマフォを用意する
  - セマフォの確保に成功したプロセス(カーネル処理)のみが資源にアクセスする許可を与えられる

## 割り込みコンテキストの排他
- カーネル資源はプロセスからだけでなく、割り込み処理からも参照される
  - 割り込み処理からも参照される資源へのアクセスはセマフォを利用した排他ができない
  - セマフォは既に対象資源が確保されている場合、開放されるまで待機状態になろうとするため

### ハードウェア割り込みの禁止
- 割り込みコンテキストから操作される可能性のある資源に排他アクセスするにはCPUへの割り込みを禁止することが一番簡単

### ソフト割り込み禁止
- ソフト割り込みのコンテキストから操作される可能性がある資源は、ソフト割り込みハンドラの実行を抑制することでは板アクセスを実現できる
- マルチプロセッサシステムにおいては、他のプロセッサからも資源がアクセスされる可能性がある
  - ほとんどの場合、ソフト割り込み禁止はスピンロックと組み合わせて利用される
## マルチプロセッサ環境での排他
### スピンロック
- マルチプロセッサシステムにおいてCPU間の競合を調停するための排他の仕組み
- スピンロックでは、メモリ上にロック変数を配置しこの変数を早い者勝ちで各CPUが奪い合う
  - このロック変数を取得できたCPUがロックで守られた資源の操作を許される
  - ロック変数を取得できなかったCPUはロックが解除されるまで、その場でループして待ち続ける(ビジーウェイト)

### RCU
- Read Copy Updateと呼ばれるマルチプロセッサ向けの軽量な排他機構
- ポインタで相互に結合されたデータ構造を保護する際に利用できる
- Linux 2.6より前はスピンロックが使用されていたが、2.6からRCUで保護できるようになった
- RCUで保護された資源はリストやツリー形で管理される
  - このリストやツリーを辿り目的の資源を見つけて参照する
  - リストやツリーを辿っている間に他のCPUがリストやツリーの構造を変更することも可能
